<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1 20151215//EN" "JATS-archivearticle1.dtd"> 
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" article-type="research-article"><?properties open_access?><?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?><?DTDIdentifier.IdentifierType public?><?SourceDTD.DTDName A++V2.4.dtd?><?SourceDTD.Version 2.4?><?ConverterInfo.XSLTName springer2nlmx2.xsl?><?ConverterInfo.Version 1?><front><journal-meta><journal-id journal-id-type="nlm-ta">BMC Bioinformatics</journal-id><journal-id journal-id-type="iso-abbrev">BMC Bioinformatics</journal-id><journal-title-group><journal-title>BMC Bioinformatics</journal-title></journal-title-group><issn pub-type="epub">1471-2105</issn><publisher><publisher-name>BioMed Central</publisher-name><publisher-loc>London</publisher-loc></publisher></journal-meta><article-meta><article-id pub-id-type="pmcid">6044013</article-id><article-id pub-id-type="publisher-id">2263</article-id><article-id pub-id-type="doi">10.1186/s12859-018-2263-6</article-id><article-categories><subj-group subj-group-type="heading"><subject>Methodology Article</subject></subj-group></article-categories><title-group><article-title><SecTag type="TITLE"><text><SENT sid="0" pm="."><plain>Alternative empirical Bayes models for adjusting for batch effects in genomic studies </plain></SENT>
</text></SecTag></article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Zhang</surname><given-names>Yuqing</given-names></name><address><email>yuqingz@bu.edu</email></address><xref ref-type="aff" rid="Aff1">1</xref><xref ref-type="aff" rid="Aff2">2</xref></contrib><contrib contrib-type="author"><name><surname>Jenkins</surname><given-names>David F.</given-names></name><xref ref-type="aff" rid="Aff1">1</xref><xref ref-type="aff" rid="Aff2">2</xref></contrib><contrib contrib-type="author"><name><surname>Manimaran</surname><given-names>Solaiappan</given-names></name><xref ref-type="aff" rid="Aff1">1</xref><xref ref-type="aff" rid="Aff3">3</xref></contrib><contrib contrib-type="author" corresp="yes"><contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-6247-6595</contrib-id><name><surname>Johnson</surname><given-names>W. Evan</given-names></name><address><email>wej@bu.edu</email></address><xref ref-type="aff" rid="Aff1">1</xref><xref ref-type="aff" rid="Aff2">2</xref><xref ref-type="aff" rid="Aff3">3</xref></contrib><aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 0367 5222</institution-id><institution-id institution-id-type="GRID">grid.475010.7</institution-id><institution>Division of Computational Biomedicine, Boston University School of Medicine, </institution></institution-wrap>72 East Concord Street, Boston, 02118 MA USA </aff><aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 1936 7558</institution-id><institution-id institution-id-type="GRID">grid.189504.1</institution-id><institution>Graduate Program in Bioinformatics, Boston University, </institution></institution-wrap>24 Cummington Mall, Boston, 02215 MA USA </aff><aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 1936 7558</institution-id><institution-id institution-id-type="GRID">grid.189504.1</institution-id><institution>Department of Biostatistics, Boston University School of Public Health, </institution></institution-wrap>715 Albany Street, Boston, 02118 MA USA </aff></contrib-group><pub-date pub-type="epub"><day>13</day><month>7</month><year>2018</year></pub-date><pub-date pub-type="pmc-release"><day>13</day><month>7</month><year>2018</year></pub-date><pub-date pub-type="collection"><year>2018</year></pub-date><volume>19</volume><elocation-id>262</elocation-id><history><date date-type="received"><day>11</day><month>1</month><year>2018</year></date><date date-type="accepted"><day>26</day><month>6</month><year>2018</year></date></history><permissions><copyright-statement>© The Author(s) 2018</copyright-statement><license license-type="OpenAccess"><license-p><bold>Open Access</bold> This article is distributed under the terms of the Creative Commons Attribution 4.0 International License(<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted use, distribution, and reproduction in any medium, provided you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The Creative Commons Public Domain Dedication waiver(<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated.</license-p></license></permissions><abstract id="Abs1"><sec><title><text><SENT sid="1" pm="."><plain>Background </plain></SENT>
</text></title><p><SecTag type="ABS"><text><SENT sid="2" pm="."><plain>Combining genomic data sets from multiple studies is advantageous to increase statistical power in studies where logistical considerations restrict sample size or require the sequential generation of data. </plain></SENT>
<SENT sid="3" pm="."><plain>However, significant technical heterogeneity is commonly observed across multiple batches of data that are generated from different processing or reagent batches, experimenters, protocols, or profiling platforms. </plain></SENT>
<SENT sid="4" pm="."><plain>These so-called batch effects often confound true biological relationships in the data, reducing the power benefits of combining multiple batches, and may even lead to spurious results in some combined studies. </plain></SENT>
<SENT sid="5" pm="."><plain>Therefore there is significant need for effective methods and software tools that account for batch effects in high-throughput genomic studies. </plain></SENT>
</text></SecTag></p></sec><sec><title><text><SENT sid="6" pm="."><plain>Results </plain></SENT>
</text></title><p><SecTag type="ABS"><text><SENT sid="7" pm="."><plain>Here we contribute multiple methods and software tools for improved combination and analysis of data from multiple batches. </plain></SENT>
<SENT sid="8" pm="."><plain>In particular, we provide batch effect solutions for cases where the severity of the batch effects is not extreme, and for cases where one high-quality batch can serve as a reference, such as the training set in a biomarker study. </plain></SENT>
<SENT sid="9" pm="."><plain>We illustrate our approaches and software in both simulated and real data scenarios. </plain></SENT>
</text></SecTag></p></sec><sec><title><text><SENT sid="10" pm="."><plain>Conclusions </plain></SENT>
</text></title><p><SecTag type="ABS"><text><SENT sid="11" pm="."><plain>We demonstrate the value of these new contributions compared to currently established approaches in the specified batch correction situations. </plain></SENT>
</text></SecTag></p></sec><sec><title><text><SENT sid="12" pm="."><plain>Electronic supplementary material </plain></SENT>
</text></title><p><SecTag type="ABS"><text><SENT sid="13" pm="."><plain>The online version of this article (10.1186/s12859-018-2263-6) contains supplementary material, which is available to authorized users. </plain></SENT>
</text></SecTag></p></sec></abstract><SecTag type="KEYWORD"><kwd-group xml:lang="en"><title>Keywords</title><kwd>Batch effects</kwd><kwd>Empirical Bayes models</kwd><kwd>Data integration</kwd><kwd>Biomarker development</kwd></kwd-group></SecTag><funding-group><award-group><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000066</institution-id><institution>National Institute of Environmental Health Sciences</institution></institution-wrap></funding-source><award-id>NIH R01ES025002</award-id></award-group></funding-group><funding-group><award-group><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000054</institution-id><institution>National Cancer Institute</institution></institution-wrap></funding-source><award-id>U01CA164720</award-id></award-group></funding-group><custom-meta-group><custom-meta><meta-name>issue-copyright-statement</meta-name><meta-value>© The Author(s) 2018</meta-value></custom-meta></custom-meta-group></article-meta></front><body><SecTag type="INTRO"><sec id="Sec1"><title><text><SENT sid="14" pm="."><plain>Background </plain></SENT>
</text></title><p><text><SENT sid="15" pm="."><plain>In the past two decades, owing to the advent of novel high-throughput techniques, tens of thousands of genome profiling experiments have been performed [1, 2]. </plain></SENT>
<SENT sid="16" pm="."><plain>These massive data sets can be used for many purposes, including understanding basic biological function, classifying molecular subtypes of disease, characterizing disease etiology, or predicting disease prognosis and severity. </plain></SENT>
<SENT sid="17" pm="."><plain>Initially, the majority of these studies were completed using microarray platforms, but sequencing platforms are now common for many applications. </plain></SENT>
<SENT sid="18" pm="."><plain>Across these platforms, thousands of variations on technology and annotation have been used [3]. </plain></SENT>
<SENT sid="19" pm="."><plain>Scientists who seek to integrate data across platforms may experience difficulty because platforms introduce distinct technological biases and produce data with different shapes and scales. </plain></SENT>
<SENT sid="20" pm="."><plain>For example, gene expression microarrays typically measure transcription levels on a continuous (log-) intensity scale, whereas RNA-sequencing measures the same biological phenomena with overdispersed and zero-inflated count data. </plain></SENT>
<SENT sid="21" pm="."><plain>Furthermore, even with data from the same platform, large amounts of technical and biological heterogeneity is commonly observed between separate batches or experiments. </plain></SENT>
<SENT sid="22" pm="."><plain>Due to the high cost of these experiments or the difficulty in collecting appropriate samples, datasets are often processed in small batches, at different times, and in different facilities. </plain></SENT>
<SENT sid="23" pm="."><plain>This proves to be a difficult challenge to researchers wanting to combine studies to increase statistical power in their analyses. </plain></SENT>
</text></p><p><text><SENT sid="24" pm="."><plain>One illustrative example of cross-platform (and within-platform) heterogeneity can be found in The Cancer Genome Atlas (TCGA) [4]. </plain></SENT>
<SENT sid="25" pm="."><plain>Profiling data types collected by TCGA include RNA expression, microRNA expression, protein expression, DNA methylation, copy number variation, and somatic mutations. </plain></SENT>
<SENT sid="26" pm="."><plain>Within each profiling type, multiple platforms are often used. </plain></SENT>
<SENT sid="27" pm="."><plain>For example, RNA expression has been measured with RNA-sequencing (using multiple different protocols) and several different microarray platforms including Agilent G4502A, Affymetrix HG-U133A, and Affymetrix Human Exon 1.0 ST, among others. </plain></SENT>
<SENT sid="28" pm="."><plain>Many of the tumor samples are profiled by only a subset of the possible data types and platforms, and in almost all cases the samples within each platform were generated in multiple experimental batches. </plain></SENT>
<SENT sid="29" pm="."><plain>This presents problems to researchers wanting to do comprehensive and integrative analyses, as they often limit their analyses to a single data type or platform. </plain></SENT>
<SENT sid="30" pm="."><plain>Furthermore, other existing data resources (e.g. ENCODE, LINCS, Epigenome Roadmap) utilize different platforms and protocols, and researchers often want to combine their own experimental data with data from these public repositories. </plain></SENT>
<SENT sid="31" pm="."><plain>Therefore, these necessitate robust and sophisticated standardization and batch correction methods in order to appropriately integrate data within and across these consortiums. </plain></SENT>
</text></p><p><text><SENT sid="32" pm="."><plain>Many prior studies have clearly established the need for batch effect correction [5, 6]. </plain></SENT>
<SENT sid="33" pm="."><plain>To address these difficulties, existing tools have been developed for batch correction. </plain></SENT>
<SENT sid="34" pm="."><plain>Some of the first batch effect methods relied on singular value decomposition (SVD) [7], machine learning classification approaches (DWD) [8], or a block linear model (XPN) [9]. </plain></SENT>
<SENT sid="35" pm="."><plain>The SVD approach relies on the identification of batch effects by the unsupervised matrix decomposition, which will commonly result in the removal of biological signal of interest. </plain></SENT>
<SENT sid="36" pm="."><plain>The DWD and XPN methods provide supervised approaches for combining data, but are mostly used to combine two batches at a time, and do not account for treatment effects. </plain></SENT>
<SENT sid="37" pm="."><plain>These methods need to be applied multiple times in an ad hoc manner for studies with three or more batches, and are not flexible enough to handle multiple experimental conditions, or studies with unbalanced experimental designs. </plain></SENT>
<SENT sid="38" pm="."><plain>More recent and flexible methods rely on robust empirical Bayes regression (ComBat) [10], the efficient use of control probes or samples (RUV) [11], or more sophisticated unsupervised data decomposition (SVA) [12] to remove heterogeneity from multiple studies while preserving the biological signal of interest in the data, even when the experimental design across the studies are not balanced. </plain></SENT>
</text></p><p><text><SENT sid="39" pm="."><plain>However, despite these useful existing approaches for data cleaning and combination, there are still significant gaps that need to be addressed for certain data integration scenarios. </plain></SENT>
<SENT sid="40" pm="."><plain>For example, the ComBat approach removes batch effects impacting both the means and variances of each gene across the batches. </plain></SENT>
<SENT sid="41" pm="."><plain>However, in some cases, the data might require a less (or more) extreme batch adjustment. </plain></SENT>
<SENT sid="42" pm="."><plain>Below, we present higher order moment-based metrics and visualizations for evaluating the extent to which batch effects impact the data. </plain></SENT>
<SENT sid="43" pm="."><plain>Then, at least in the case of less severe batch effects, we propose a simplified empirical Bayes approach for batch adjustment. </plain></SENT>
</text></p><p><text><SENT sid="44" pm="."><plain>Another limitation of the current ComBat model is that it adjusts the data for each gene to match an overall, or common cross-batch mean, estimated using samples from all batches. </plain></SENT>
<SENT sid="45" pm="."><plain>While this approach is advantageous for cases with small sample size or where the batches are of similar caliber and size, this is not the best solution when one batch is of superior quality or can be considered a natural ’reference’. </plain></SENT>
<SENT sid="46" pm="."><plain>In addition, the current ComBat approach suffers from sample ’set bias’ [13], meaning that if samples or batches are added to or removed from the set of samples on hand, the batch adjustment must be reapplied, and the adjusted values will be different–even for the samples that remained in the dataset in all scenarios. </plain></SENT>
<SENT sid="47" pm="."><plain>In some cases, the impact of this set bias can be significant. </plain></SENT>
<SENT sid="48" pm="."><plain>For example, consider a biomarker study, where a genomic signature is derived in one study batch (training set) and then later applied or validated in future samples/batches (test sets) which were not collected at the time of biomarker generation. </plain></SENT>
<SENT sid="49" pm="."><plain>Once the test sets are obtained and combined with the training data using ComBat, the post-ComBat training data may change and the biomarker may need to be regenerated. </plain></SENT>
<SENT sid="50" pm="."><plain>Many statistical tests that are commonly used for biomarker derivation, such as t-test and F-test, involve calculating data variance. </plain></SENT>
<SENT sid="51" pm="."><plain>As ComBat adjustment reduces or expands the variance for each gene, it will result in a different test statistics, followed by an increased or reduced P value. </plain></SENT>
<SENT sid="52" pm="."><plain>This may cause certain genes to be included or excluded from the biomarker list, resulting in a different biomarker from before. </plain></SENT>
<SENT sid="53" pm="."><plain>If ComBat is applied on multiple training/test combinations separately (i.e. say at different times), then the derived biomarker may be different between different dataset combinations. </plain></SENT>
<SENT sid="54" pm="."><plain>Therefore, the value of establishing the training set as a ’reference batch’ to which all future batches will be standardized would have a significant impact. </plain></SENT>
<SENT sid="55" pm="."><plain>This would allow the training data and biomarker to be fixed a priori but still enable the application of the biomarker on an unlimited set of future validation or clinical cohorts. </plain></SENT>
</text></p><p><text><SENT sid="56" pm="."><plain>Although these alternative models for batch only represent alternative formulations of the original ComBat modeling approach, their implementation will have significant downstream impacts on certain batch combination scenarios. </plain></SENT>
<SENT sid="57" pm="."><plain>Below, we detail these modifications and demonstrate their utility and increased efficacy on real data examples. </plain></SENT>
</text></p></sec></SecTag><SecTag type="METHODS"><sec id="Sec2"><title><text><SENT sid="58" pm="."><plain>Methods </plain></SENT>
</text></title><p><text><SENT sid="59" pm="."><plain>We present several approaches for improved diagnostics and batch effect adjustment for certain batch adjustment situations. </plain></SENT>
<SENT sid="60" pm="."><plain>We focus on developing models based on the ComBat empirical Bayes batch adjustment approach, although similar methods and models can be applied to other existing approaches. </plain></SENT>
<SENT sid="61" pm="."><plain>One set of diagnostic procedures attempts to characterize the distributional (mean, variance, skewness, kurtosis, etc) differences across batches. </plain></SENT>
<SENT sid="62" pm="."><plain>We present a solution for the cases where adjusting only the mean of the batch effect is sufficient for harmonizing the data across batches. </plain></SENT>
<SENT sid="63" pm="."><plain>In addition, we present an approach that allows the user to select a reference batch, or a batch that is left static after batch adjustment, and to which all the other batches are adjusted. </plain></SENT>
<SENT sid="64" pm="."><plain>This approach makes sense in situations where one batch or dataset is of better quality or less variable. </plain></SENT>
<SENT sid="65" pm="."><plain>In addition, this approach will be particularly helpful for biomarker studies, where one dataset is used for training a fixed biomarker, then the fixed biomarker is applied on multiple different batches or datasets, even at different times. </plain></SENT>
<SENT sid="66" pm="."><plain>This approach avoids the negative impacts of test set bias in the generation of the biomarker signatures. </plain></SENT>
<SENT sid="67" pm="."><plain>Below we describe the methodological developments for these cases. </plain></SENT>
</text></p><sec id="Sec3"><title><text><SENT sid="68" pm="."><plain>ComBat batch adjustment </plain></SENT>
</text></title><p><text><SENT sid="69" pm="."><plain>ComBat [10] is a flexible and straightforward approach to remove technical artifacts due to processing facility and data batch. </plain></SENT>
<SENT sid="70" pm="."><plain>ComBat has been established as one of the most common approaches for combining genomic data across experiments, labs, and platforms [14], and has been shown to be useful for data from a broad range of types and biological systems [15, 16]. </plain></SENT>
<SENT sid="71" pm="."><plain>The ComBat batch adjustment approach assumes that batch effects represent non-biological but systematic shifts in the mean or variability of genomic features for all samples within a processing batch. </plain></SENT>
<SENT sid="72" pm="."><plain>ComBat assumes the genomic data (Yijg) for gene g, batch i, and sample j (within batch i) follows the model: 1\documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document} $$\begin{array}{@{}rcl@{}} Y_{ijg} = \alpha_{g} + X_{ij}\beta_{g} + \gamma_{ig} + \delta_{ig}\varepsilon_{ijg} \end{array} $$ \end{document}Yijg=αg+Xijβg+γig+δigεijg </plain></SENT>
</text></p><p><text><SENT sid="73" pm="."><plain>where αg is the overall gene expression. Xij is a known design matrix for sample conditions, and βg is the vector of regression coefficients corresponding to Xij. γig and δig represent the additive and multiplicative batch effects of batch i for gene g, which affect the mean and variance of gene expressions within batch i, respectively. </plain></SENT>
<SENT sid="74" pm="."><plain>The error terms, εijg, are assumed to follow a normal distribution with expected value of zero and variance \documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document}$\sigma _{g}^{2}$\end{document}σg2. </plain></SENT>
<SENT sid="75" pm="."><plain>ComBat assumes either parametric or nonparametric hierarchical Bayesian priors in the batch effect parameters (γig and δig) and uses an empirical Bayes procedure to estimate these parameters [10]. </plain></SENT>
<SENT sid="76" pm="."><plain>This procedure pools information across genes in each batch to shrink the batch effect parameter estimates toward the overall mean of the batch effect empirical estimates. </plain></SENT>
<SENT sid="77" pm="."><plain>These are used to adjust the data for batch effects. </plain></SENT>
<SENT sid="78" pm="."><plain>This approach provides a robust and often more accurate adjustment for the batch effect on each gene. </plain></SENT>
</text></p></sec><sec id="Sec4"><title><text><SENT sid="79" pm="."><plain>Moment-based diagnostics for batch effects </plain></SENT>
</text></title><p><text><SENT sid="80" pm="."><plain>The ComBat model described above robustly estimates both the mean and the variance of each batch using empirical Bayes shrinkage, then adjusts the data according to these estimates. </plain></SENT>
<SENT sid="81" pm="."><plain>However, in some cases, adjusting only the mean of the batches may be sufficient for further analysis. </plain></SENT>
<SENT sid="82" pm="."><plain>In other scenarios (see examples in “” below), adjustment of the mean and variance is not sufficient, and thus the adjustment of higher order moments is needed. </plain></SENT>
<SENT sid="83" pm="."><plain>Here, we present multiple diagnostics for interrogating the shape of the distribution of batches to determine how batch effect should be adjusted. </plain></SENT>
</text></p><p><text><SENT sid="84" pm="."><plain>As with ComBat, we assume that in the presence of batch effect, the mean and variance (as well as higher order moments) of gene expression demonstrate systematic differences across batches on a standardized scale [10]. </plain></SENT>
<SENT sid="85" pm="."><plain>Thus, we standardize the data as we have done previously, namely by estimating the model (1) above, obtaining the estimates for the parameters and calculating the standardized data, Zijg, as follows: 2\documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document} $$\begin{array}{@{}rcl@{}} Z_{ijg} = \frac{Y_{ijg} - \hat{\alpha}_{g} - X_{ij}\hat{\beta}_{g}}{\hat{\sigma}_{g}} \end{array} $$ \end{document}Zijg=Yijg−α^g−Xijβ^gσ^g </plain></SENT>
</text></p><p><text><SENT sid="86" pm="."><plain>After standardization, we assume the standardized data, Zijg, originate from a distribution with mean γig, variance \documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document}$\delta _{ig}^{2}$\end{document}δig2, skewness ηig, and kurtosis ϕig. </plain></SENT>
<SENT sid="87" pm="."><plain>In addition, consistent with the ComBat assumptions, we assume that each of these moments originates from a common distribution (henceforth denoted the hyper-distribution), namely that the γig are drawn from a distribution with mean γi that is common across all genes. </plain></SENT>
<SENT sid="88" pm="."><plain>Similar assumptions of exchangeability across genes are made about the variance, skewness, and kurtosis. </plain></SENT>
</text></p><p><text><SENT sid="89" pm="."><plain>We apply two tests of significance to individually test for significant differences in these moments across batches. </plain></SENT>
<SENT sid="90" pm="."><plain>In both of the tests, we estimate and conduct the test on the hyper-moments (i.e. moments of the hyper-distribution) across batches. </plain></SENT>
<SENT sid="91" pm="."><plain>The first test estimates the hyper-moments within each sample, whereas the other test estimates the hyper-moments within each gene. </plain></SENT>
<SENT sid="92" pm="."><plain>The first, sample-based test is more robust for small sample size, whereas the second, gene-based test is more robust and sensitive in larger sample size. </plain></SENT>
<SENT sid="93" pm="."><plain>Finally, for quantile-normalized data [17], the sample-wise test will fail because quantile normalization will naturally force all moments to be the same across samples. </plain></SENT>
<SENT sid="94" pm="."><plain>So for quantile normalized data, the gene-wise test will be needed. </plain></SENT>
</text></p><sec id="Sec5"><title><text><SENT sid="95" pm="."><plain>Sample-level moments </plain></SENT>
</text></title><p><text><SENT sid="96" pm="."><plain>The first test is a sample-level test that estimates the hyper-moments by summarizing the moments of gene expression within each sample, and then conducts a standard or robust F-test (described below) to compare the moment estimates across batches. </plain></SENT>
<SENT sid="97" pm="."><plain>For example, for the mean, the sample-wise test first estimates the mean gene expression of each sample, namely 3\documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document} $$\begin{array}{@{}rcl@{}} \bar{\gamma}_{ij} = \frac{1}{n_{g}}\sum_{g}Z_{ijg} \end{array} $$ \end{document}γ¯ij=1ng∑gZijg </plain></SENT>
</text></p><p><text><SENT sid="98" pm="."><plain>where ng is the total number of genes. </plain></SENT>
<SENT sid="99" pm="."><plain>We then conduct an F-test on the \documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document}$\bar {\gamma }_{ij}$\end{document}γ¯ij values between batches. </plain></SENT>
<SENT sid="100" pm="."><plain>Similarly, the variance, skewness, and kurtosis of the Zijg are estimated across genes within each sample (using standard estimation approaches for these moments) and then tested for significant differences across batches in the same way as the mean. </plain></SENT>
<SENT sid="101" pm="."><plain>Overall this is not specifically testing the moments of the assumed ComBat model hyper-distribution, but rather the marginal distribution of the data and hyper-distributions of the data. </plain></SENT>
</text></p></sec><sec id="Sec6"><title><text><SENT sid="102" pm="."><plain>Gene-level moments </plain></SENT>
</text></title><p><text><SENT sid="103" pm="."><plain>The second test is a gene-level test that estimates the hyper-moments within each gene, using samples in each batch separately, and then conducts a robust F-test comparing the moment estimates across batches. </plain></SENT>
<SENT sid="104" pm="."><plain>For example, for the mean, the gene-wise test first estimates the mean of each gene across samples within a batch, namely 4\documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document} $$\begin{array}{@{}rcl@{}} \bar{\gamma}_{ig} = \frac{1}{n_{i}}\sum_{j}Z_{ijg} \end{array} $$ \end{document}γ¯ig=1ni∑jZijg </plain></SENT>
</text></p><p><text><SENT sid="105" pm="."><plain>where ni is the total number of samples in batch i. </plain></SENT>
<SENT sid="106" pm="."><plain>We then conduct a test of significance on the \documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document}$\bar {\gamma }_{ig}$\end{document}γ¯ig values between batches. </plain></SENT>
<SENT sid="107" pm="."><plain>Similarly, the variance, skewness, and kurtosis of the Zijg are estimated across samples within each batch for each gene (using standard estimation approaches for these moments) and then tested for significant differences across batches in the same way as the mean. </plain></SENT>
<SENT sid="108" pm="."><plain>Unlike the sample-wise test, this test more specifically follows the ComBat hierarchical model assumption, by first estimating the parameters drawn from the hyper-distribution. </plain></SENT>
</text></p></sec><sec id="Sec7"><title><text><SENT sid="109" pm="."><plain>Robust F-test </plain></SENT>
</text></title><p><text><SENT sid="110" pm="."><plain>In hypothesis testing, a large enough sample size may cause the P-value problem [18]: small effects with no practical importance can be detected significant, as the P-value quickly drops to zero under a very large sample size. </plain></SENT>
<SENT sid="111" pm="."><plain>The P-value problem influences tests that are sensitive to the sample size, including the F-test used in this study. </plain></SENT>
<SENT sid="112" pm="."><plain>To address this problem and better interpret the results of the two tests above, we applied a robust F-test. </plain></SENT>
<SENT sid="113" pm="."><plain>The robust F-test is modified from standard F test, by adding a variance inflation factor in the F statistics, which accounts for the influence of the sample size in P-values. </plain></SENT>
<SENT sid="114" pm="."><plain>Details of the robust F-test are documented in Additional file 1. </plain></SENT>
</text></p><p><text><SENT sid="115" pm="."><plain>The robust F-test is especially useful for the gene-level test, as the total degrees of freedom in this test is in fact the amount of moment estimates, which equals to the number of genes times the number of batches. </plain></SENT>
<SENT sid="116" pm="."><plain>This value can easily become very large in genomic studies. </plain></SENT>
<SENT sid="117" pm="."><plain>We used both the robust and the non-robust versions of F statistics in the sample- and gene-level tests, and evaluated and compared their performances in diagnosing the degree of batch effect in our example data. </plain></SENT>
</text></p></sec></sec><sec id="Sec8"><title><text><SENT sid="118" pm="."><plain>Mean-only adjustment for batch effects </plain></SENT>
</text></title><p><text><SENT sid="119" pm="."><plain>The current ComBat model adjusts for effects in both the mean and the variance across batches. </plain></SENT>
<SENT sid="120" pm="."><plain>However, for some datasets, after testing for the moments of the batch effect, it may be determined that differences are only present in the mean across batches. </plain></SENT>
<SENT sid="121" pm="."><plain>Other datasets may be expected to have variance differences across batches for non-technical reasons, such as in a study combining a in vitro perturbation experiment (low variance) with patient samples (high variance). </plain></SENT>
<SENT sid="122" pm="."><plain>For cases in which that batch differences are only present in the mean, we have modified the current ComBat model to only adjust the mean batch effect. </plain></SENT>
<SENT sid="123" pm="."><plain>Specifically, we modify the ComBat model (1) as follows: 5\documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document} $$\begin{array}{@{}rcl@{}} Y_{ijg} = \alpha_{g} + X_{ij}\beta_{g} + \gamma_{ig} + \varepsilon_{ijg} \end{array} $$ \end{document}Yijg=αg+Xijβg+γig+εijg </plain></SENT>
</text></p><p><text><SENT sid="124" pm="."><plain>and then use the same approach for standardization and shrinkage as described previously with the exception of not estimating and adjusting for variance differences across batches. </plain></SENT>
</text></p></sec><sec id="Sec9"><title><text><SENT sid="125" pm="."><plain>Reference batch adjustment </plain></SENT>
</text></title><p><text><SENT sid="126" pm="."><plain>Many batch adjustment approaches, including ComBat, are dependent on the datasets in hand for their batch adjustments. </plain></SENT>
<SENT sid="127" pm="."><plain>In other words, if additional samples or batches of data are added, the batch adjustments and adjusted data would be different. </plain></SENT>
<SENT sid="128" pm="."><plain>We present a reference-based batch adjustment approach that uses one batch as the baseline for the batch adjustment. </plain></SENT>
<SENT sid="129" pm="."><plain>The reference batch is not changed and the other batches are adjusted to the mean and variance of the reference. </plain></SENT>
<SENT sid="130" pm="."><plain>Thus, as long as the reference batch does not change, the adjustments and adjusted data would be the same, regardless of the batches of data that are included in the dataset. </plain></SENT>
<SENT sid="131" pm="."><plain>This also allows batches of data to be adjusted at different times without impacting the results. </plain></SENT>
<SENT sid="132" pm="."><plain>This approach will be advantageous to data generating consortiums where data arrive sequentially in small batches. </plain></SENT>
<SENT sid="133" pm="."><plain>It will also be important for applications in personalized medicine where biomarkers need to be established and validated prior to the collection of patient data. </plain></SENT>
<SENT sid="134" pm="."><plain>For our reference-based version of ComBat, we will assume a model slightly different than the model (1) presented above, namely: 6\documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document} $$\begin{array}{@{}rcl@{}} Y_{ijg} = \alpha_{rg} + X_{ij}\beta_{rg} + \gamma_{rig} + \delta_{rig}\varepsilon_{ijg} \end{array} $$ \end{document}Yijg=αrg+Xijβrg+γrig+δrigεijg </plain></SENT>
</text></p><p><text><SENT sid="135" pm="."><plain>where Xij and βrg are the design matrix and regression coefficients as described before, but αrg is the average gene expression in the chosen reference batch (r). </plain></SENT>
<SENT sid="136" pm="."><plain>Furthermore, γrig and δrig represent the additive and multiplicative batch differences between the reference batch and batch i for gene g. </plain></SENT>
<SENT sid="137" pm="."><plain>The error terms, εijg, are assumed to follow a normal distribution with expected value of zero and a reference batch variance \documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document}$\sigma _{rg}^{2}$\end{document}σrg2. </plain></SENT>
<SENT sid="138" pm="."><plain>The empirical Bayes estimates for γrig and δrig will be obtained as in the current ComBat approach. </plain></SENT>
</text></p></sec><sec id="Sec10"><title><text><SENT sid="139" pm="."><plain>Software implementation </plain></SENT>
</text></title><p><text><SENT sid="140" pm="."><plain>The models presented here have been integrated into the ComBat function available in the ’sva’ Bioconductor package (version 3.26.0) [12, 19]. </plain></SENT>
<SENT sid="141" pm="."><plain>More specifically, ComBat now includes optional parameters ’mean.only’, which if TRUE will only adjust the mean batch effect and not the variance, and ’ref.batch’, which allows the user to specify the batch name or number to be used as the reference batch. </plain></SENT>
<SENT sid="142" pm="."><plain>Our moment-based diagnostic tests for the mean, variance, skewness, and kurtosis are now available in our ’BatchQC’ Bioconductor package [20]. </plain></SENT>
<SENT sid="143" pm="."><plain>BatchQC is an R software package designed to automate many important evaluation tasks needed to properly combine data from multiple batches or studies. </plain></SENT>
<SENT sid="144" pm="."><plain>BatchQC conducts comprehensive exploratory analyses and constructs interactive graphics for genomic datasets to discover the sources of technical variation that are present across multiple sets of samples. </plain></SENT>
<SENT sid="145" pm="."><plain>BatchQC currently provides both the supervised diagnostics for known sources of technical variation (data generating batch, reagent date, RNA-quality, etc) as well as an unsupervised evaluation of batch effects to detect unmeasured non-biological variability or ’surrogate variables’ [12]. </plain></SENT>
</text></p></sec><sec id="Sec11"><title><text><SENT sid="146" pm="."><plain>Dataset descriptions </plain></SENT>
</text></title><sec id="Sec12"><title><text><SENT sid="147" pm="."><plain>Pathway simulation </plain></SENT>
</text></title><p><text><SENT sid="148" pm="."><plain>We generated simulated data to represent a case where we (1) derive a gene expression signature of a biological pathway or drug perturbation, and (2) profile the signature into another batch of data to predict pathway activity (or drug efficacy). </plain></SENT>
<SENT sid="149" pm="."><plain>The study consists of two experimental batches which are designed as follows: batch 1 is given by a 200 (gene) by 6 (sample) matrix of expression data, where the columns contain three replicate samples before pathway activation and three after activation (i.e. overexpressing key pathway driving genes). </plain></SENT>
<SENT sid="150" pm="."><plain>Among the 200 genes, the first 100 represent ’signature genes’ that are differentially expressed (before vs. after) based on a ’before’ Gaussian distribution: N(0,0.1), and an ’after’ distribution: N(1,0.1). </plain></SENT>
<SENT sid="151" pm="."><plain>The rest of the genes are drawn from a N(0,0.1) distribution in all 6 samples, representing genes that do not respond to the pathway perturbation. </plain></SENT>
<SENT sid="152" pm="."><plain>Batch 2 consists of a 200 (gene; same genes as batch 1) by 600 (sample) matrix, and represents a large and highly variable patient data set. </plain></SENT>
<SENT sid="153" pm="."><plain>The 600 patients are divided equally into 6 subgroups with different levels of pathway activation between groups; signature genes are drawn from a N(μ,10) distribution, where μ=0.5,0.7,0.9,1.1,1.3, and 1.5 for the six subgroups. </plain></SENT>
<SENT sid="154" pm="."><plain>The control genes are drawn from a N(0.5,10) distribution. </plain></SENT>
<SENT sid="155" pm="."><plain>We set up these simulation studies based on the design of real signature profiling studies [21], and selected parameters to capture the statistical properties of realistic gene expression distributions (Additional file 2). </plain></SENT>
<SENT sid="156" pm="."><plain>Simulation code for this dataset is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/zhangyuqing/meanonly_reference_combat">https://github.com/zhangyuqing/meanonly_reference_combat</ext-link>. </plain></SENT>
</text></p></sec><sec id="Sec13"><title><text><SENT sid="157" pm="."><plain>Bladder cancer </plain></SENT>
</text></title><p><text><SENT sid="158" pm="."><plain>We used a previously published bladder cancer microarray dataset, which aims to measure gene expression in superficial transitional cell carcinoma (sTCC) in the presence and absence of carcinoma in situ (CIS) [22]. </plain></SENT>
<SENT sid="159" pm="."><plain>This dataset contains 57 observations generated at 5 different processing times. </plain></SENT>
<SENT sid="160" pm="."><plain>It was previously established that the processing time is strongly confounded with CIS condition, and batch effect still exists for certain genes after normalization of the data [19]. </plain></SENT>
</text></p></sec><sec id="Sec14"><title><text><SENT sid="161" pm="."><plain>Nitric oxide </plain></SENT>
</text></title><p><text><SENT sid="162" pm="."><plain>This study was designed to investigate whether exposing mammalian cells to nitric oxide (NO) stabilizes mRNAs [10]. </plain></SENT>
<SENT sid="163" pm="."><plain>Human lung fibroblast cells (IMR90) were exposed to NO for 1 h, then transcription inhibited together with control cells for 7.5 h. </plain></SENT>
<SENT sid="164" pm="."><plain>Expressions in the exposed sample and control cells are measured at 0 h and 7.5 h using Affymetrix HG-U133A microarray, resulting in 4 arrays for each cell pair. </plain></SENT>
<SENT sid="165" pm="."><plain>The experiment was repeated at 3 different times. </plain></SENT>
<SENT sid="166" pm="."><plain>The dataset contains the 3 batches of data, each containing 4 arrays of different treatment combinations, which leads to 12 samples in total. </plain></SENT>
</text></p></sec><sec id="Sec15"><title><text><SENT sid="167" pm="."><plain>Oncogenic signature </plain></SENT>
</text></title><p><text><SENT sid="168" pm="."><plain>The growth factor receptor network (GFRN) contributes to breast cancer progression and drug response. </plain></SENT>
<SENT sid="169" pm="."><plain>This RNA-Seq dataset is designed to develop gene signatures for several GFRN pathways: AKT, BAD, HER2, IGF1R, RAF1, KRAS, and EGFR. </plain></SENT>
<SENT sid="170" pm="."><plain>We used recombinant adenoviruses to express these genes in case samples and produce green fluorescent protein (GFP) in control samples, using replicates of human mammary epithelial cells (HMECs). </plain></SENT>
<SENT sid="171" pm="."><plain>RNA-Seq data are collected from these HMECs overexpressing GFRN genes and GFP controls [21]. </plain></SENT>
<SENT sid="172" pm="."><plain>This dataset contains 89 samples, which are created in three batches: batch 1 contains 6 replicate samples of each for AKT, BAD, IGF1R, and RAF1, 5 replicates for HER2, and 12 replicates for GFP controls (GEO accession GSE83083); batch 2 consists of 9 replicates of each for three types of KRAS mutants and GFP control (GEO accession GSE83083); batch 3 contains 6 replicates of each for EGFR and its corresponding control (GEO accession GSE59765). </plain></SENT>
<SENT sid="173" pm="."><plain>We derived signatures from this dataset and predicted pathway activities and drug effects in cell line and patient datasets with ASSIGN [23]. </plain></SENT>
</text></p></sec><sec id="Sec16"><title><text><SENT sid="174" pm="."><plain>Lung cancer </plain></SENT>
</text></title><p><text><SENT sid="175" pm="."><plain>This dataset contains microarray measurements from histologically normal bronchial epithelium cells collected during bronchoscopy from non-smokers, former smokers, and current smokers. </plain></SENT>
<SENT sid="176" pm="."><plain>Samples are selected from various studies, which are divided into three batches A (GSE994 [24], GSE4115 [25, 26], GSE7895 [27]), B (GSE66499, [28]) and C (GSE37147, [29]). </plain></SENT>
<SENT sid="177" pm="."><plain>The three sub-batches within A are ComBat adjusted before A is combined with B and C. </plain></SENT>
<SENT sid="178" pm="."><plain>The dataset contains 1051 samples, with 318 samples in batch A, 507 in batch B, and 226 in batch C. </plain></SENT>
</text></p></sec></sec></sec></SecTag><SecTag type="RESULTS"><sec id="Sec17" sec-type="results"><title><text><SENT sid="179" pm="."><plain>Results </plain></SENT>
</text></title><sec id="Sec18"><title><text><SENT sid="180" pm="."><plain>Moments-based tests of significance for batch effect </plain></SENT>
</text></title><p><text><SENT sid="181" pm="."><plain>We introduced sample- and gene-wise tests to detect significant differences in the moments of batch effect distributions. </plain></SENT>
<SENT sid="182" pm="."><plain>We applied these tests to four different datasets (Table 1) and observed their properties. </plain></SENT>
<SENT sid="183" pm="."><plain>We found that the four datasets have different degrees of batch effect, and require different adjustment. </plain></SENT>
<SENT sid="184" pm="."><plain>The first dataset (bladder cancer) has significant mean differences between the batches (P&lt;0.0001), but has P-values above 0.33 for variance differences for both tests. </plain></SENT>
<SENT sid="185" pm="."><plain>Since the bladder cancer dataset only exhibits batch effects in the mean and not in the variance, mean-only adjustment is more suitable for this dataset. </plain></SENT>
<SENT sid="186" pm="."><plain>In the nitric oxide dataset, however, mean/variance ComBat is required to remove the difference in batch variances detected by the gene-wise test (P=0.0005 without adjustment; P=0.0042 using mean-only ComBat). </plain></SENT>
<SENT sid="187" pm="."><plain>All four datasets show certain levels of significant differences in skewness and/or kurtosis even after the mean/variance ComBat is used, which suggests that adjustment for higher order moments may be required, which is beyond the scope of this paper. Table 1P-values from sample-wise and gene-wise robust tests on four datasets, before and after batch correctionSample-wise testsGene-wise testsDatasetComBatMeanVarianceSkewnessKurtosisMeanVarianceSkewnessKurtosisBladder cancerNone&lt;0.00010.64950.05390.3149&lt;0.00010.3353&lt;0.00010.0012Mean-only0.99980.95570.14960.62360.20110.3618&lt;0.00010.0012Mean/variance10.89890.18260.27370.25380.9816&lt;0.00010.0012Nitric oxideNone0.10070.35650.10090.866&lt;0.00010.0005&lt;0.00010.9887Mean-only0.99970.5770.98380.94850.45950.0042&lt;0.00010.9887Mean/variance10.9820.98470.70130.72450.6219&lt;0.00010.9791Oncogenic signatureNone0.0011&lt;0.00010.00010.0235&lt;0.00010.0001&lt;0.00010.5711Mean/variance10.74860.55530.92020.03630.8919&lt;0.00010.5711Lung cancerNone&lt;0.0001&lt;0.0001&lt;0.0001&lt;0.0001&lt;0.00010.0106&lt;0.00010.4853Mean/variance10.98720.00030.96120.00160.9971&lt;0.00010.4853The four datasets have different degrees of batch effect. </plain></SENT>
<SENT sid="188" pm="."><plain>The bladder cancer dataset has differences in batch mean, but does not show any batch effect in the variance. </plain></SENT>
<SENT sid="189" pm="."><plain>Mean-only ComBat is sufficient to adjust this dataset as there is no need to adjust the variance. </plain></SENT>
<SENT sid="190" pm="."><plain>In the nitric oxide dataset, the gene-wise test reports significant differences in both the mean and the variance. </plain></SENT>
<SENT sid="191" pm="."><plain>The full mean/variance ComBat is necessary to remove batch effects in this data. </plain></SENT>
<SENT sid="192" pm="."><plain>The mean/variance ComBat cannot adjust the skewness or kurtosis. </plain></SENT>
<SENT sid="193" pm="."><plain>All four datasets exhibit certain levels of batch effect in the skewness and/or kurtosis, which may call for methods that adjust these higher order moments. </plain></SENT>
<SENT sid="194" pm="."><plain>Results comparing robust and non-robust F tests are summarized in Additional file 3 </plain></SENT>
</text></p></sec><sec id="Sec19"><title><text><SENT sid="195" pm="."><plain>Mean-only batch adjustment </plain></SENT>
</text></title><p><text><SENT sid="196" pm="."><plain>We modified the current mean/variance ComBat into a mean-only version of ComBat, which allows users to only adjust the batch effects in mean. </plain></SENT>
<SENT sid="197" pm="."><plain>It is recommended for cases where milder batch effects are expected (i.e. there is no need to adjust the variance). </plain></SENT>
<SENT sid="198" pm="."><plain>For example, we have shown in Table 1 and Additional file 3 that in the bladder cancer dataset, the mean, skewness and kurtosis are significantly different across batches. </plain></SENT>
<SENT sid="199" pm="."><plain>But there is no evidence for significant differences in the variance. </plain></SENT>
</text></p><p><text><SENT sid="200" pm="."><plain>We applied both the mean-only and mean/variance ComBat on the bladder cancer dataset to compare their performances. </plain></SENT>
<SENT sid="201" pm="."><plain>We compared batch mean (\documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document}$\bar {\gamma }_{ij}$\end{document}γ¯ij from Eq. </plain></SENT>
<SENT sid="202" pm="."><plain>(3)) and variance estimates collected within each sample in the unadjusted data, and in data adjusted by the two versions of ComBat (Fig. 1). </plain></SENT>
<SENT sid="203" pm="."><plain>Consistent with the result in Table 1 (P&lt;0.0001), the mean estimates in the original data are significantly different across batches. </plain></SENT>
<SENT sid="204" pm="."><plain>In particular, Fig. 1a shows mean-level differences in batch 2 compared to the other batches. </plain></SENT>
<SENT sid="205" pm="."><plain>Because variance estimates are not significantly different across batches, mean-only ComBat is sufficient to adjust the bladder cancer data. </plain></SENT>
<SENT sid="206" pm="."><plain>Neither version of ComBat makes the variance estimates more similarly distributed to each other than they are in the unadjusted data (Fig. 1b). </plain></SENT>
<SENT sid="207" pm="."><plain>This shows that, based on the sample-wise test, adjusting both the mean and variance of batch effects in the bladder cancer data does not give better results than only adjusting the mean. Fig. 1Distribution of sample-wise mean and variance estimates from each batch in the bladder cancer data. </plain></SENT>
<SENT sid="208" pm="."><plain>Estimates are calculated within each sample as previously described. a Boxplots of sample-wise mean estimates (\documentclass[12pt]{minimal} \usepackage{amsmath} \usepackage{wasysym} \usepackage{amsfonts} \usepackage{amssymb} \usepackage{amsbsy} \usepackage{mathrsfs} \usepackage{upgreek} \setlength{\oddsidemargin}{-69pt} \begin{document}$\bar {\gamma }_{ij}$\end{document}γ¯ij, as in Eq. </plain></SENT>
<SENT sid="209" pm="."><plain>(3)) within each batch. </plain></SENT>
<SENT sid="210" pm="."><plain>The sample-wise mean estimates for batch 2 in the unadjusted data are significantly different from the other batches. </plain></SENT>
<SENT sid="211" pm="."><plain>Both mean-only and mean/variance ComBat adequately correct this batch 2 mean difference. b Boxplots of sample-wise variance estimates across batches. </plain></SENT>
<SENT sid="212" pm="."><plain>The sample-wise variance estimates are not significantly different in the unadjusted data. </plain></SENT>
<SENT sid="213" pm="."><plain>Adjusting either just the mean or both mean and variance does not makes the estimates more similarly distributed, meaning that adjusting the variance is not necessary </plain></SENT>
</text></p><p><text><SENT sid="214" pm="."><plain>From the gene-wise perspective, we found that the mean/variance ComBat overcorrects the data by shrinking the variance of batch 3 and 4 when pooling information from all batches (Fig. 2, Additional file 1: Figure S1). </plain></SENT>
<SENT sid="215" pm="."><plain>Batch 3 (4 samples) and batch 4 (5 samples) have relatively fewer samples than the remaining three batches (11, 18 and 19 samples), and so the gene-wise variance estimates are more likely to be impacted by outlying samples. </plain></SENT>
<SENT sid="216" pm="."><plain>When mean/variance ComBat estimates the background variance using all batches, variance estimates become less variable in these two batches than in the other batches. </plain></SENT>
<SENT sid="217" pm="."><plain>Thus, the variance adjustment actually introduces differences in distribution across batches than in the original data (Additional file 1: Figure S1). </plain></SENT>
<SENT sid="218" pm="."><plain>In contrast, mean-only ComBat does not affect the variance estimates, thus avoiding the overcorrection problem. </plain></SENT>
<SENT sid="219" pm="."><plain>Therefore, mean-only ComBat is more justifiable than mean/variance ComBat for the bladder cancer data, where there is no need to adjust the variance. Fig. 2Distribution of gene-wise variance estimates from each batch in the bladder cancer data. </plain></SENT>
<SENT sid="220" pm="."><plain>Batch 3 and batch 4 have smaller sample size than the other batches, thus their variance estimates are impacted more by outlying samples. </plain></SENT>
<SENT sid="221" pm="."><plain>Mean/variance ComBat brings all estimates to the same levels, over correcting the variance estimates in batches 3 and 4. </plain></SENT>
<SENT sid="222" pm="."><plain>This leads to unwanted, less variable gene expression (see Additional file 1: Figure S1). </plain></SENT>
<SENT sid="223" pm="."><plain>Mean-only ComBat does not affect or overcorrect the variance estimates </plain></SENT>
</text></p><sec id="Sec20"><title><text><SENT sid="224" pm="."><plain>Selecting the appropriate ComBat version for each dataset </plain></SENT>
</text></title><p><text><SENT sid="225" pm="."><plain>Unlike in the bladder cancer data, mean-only ComBat is not sufficient for removing batch effects in the other three datasets. </plain></SENT>
<SENT sid="226" pm="."><plain>For example, the oncogenic signature dataset displays batch effect in both mean and variance. </plain></SENT>
<SENT sid="227" pm="."><plain>Mean/variance adjustment is required to remove the technical differences across batches (Additional file 1: Figure S2). </plain></SENT>
<SENT sid="228" pm="."><plain>As another example, the gene-wise test detects a significant difference in variance (Table 1, P=0.0005) in the nitric oxide dataset. </plain></SENT>
<SENT sid="229" pm="."><plain>In this dataset, we found that mean-only ComBat cannot completely remove the significant difference in gene-wise variance estimates across batches (Additional file 1: Figure S3). </plain></SENT>
<SENT sid="230" pm="."><plain>In this case, the mean/variance ComBat is necessary to remove the batch effect. </plain></SENT>
</text></p><p><text><SENT sid="231" pm="."><plain>We emphasize that it is critical to select the appropriate ComBat version based on the degree of batch effect in different datasets. </plain></SENT>
<SENT sid="232" pm="."><plain>We simulated datasets with two condition groups, with some genes that differentially express between the two groups. </plain></SENT>
<SENT sid="233" pm="."><plain>Samples are divided in two batches. </plain></SENT>
<SENT sid="234" pm="."><plain>We simulated three types of batch effect in the data: 1) no batch effect, 2) only differences in the mean, and 3) both mean and variance batch effects. </plain></SENT>
<SENT sid="235" pm="."><plain>We applied both the mean-only and the mean-variance ComBat on each dataset. </plain></SENT>
<SENT sid="236" pm="."><plain>Then in both adjusted and unadjusted data, we performed differential expression analysis, and calculated the type I error rate and statistical power of our detection. </plain></SENT>
<SENT sid="237" pm="."><plain>We observed that using the ComBat model corresponding to the type of batch effect in the data is able to gain more power of detection, at the same cost of type I error rate increase (Additional file 1: Figure S4). </plain></SENT>
<SENT sid="238" pm="."><plain>These results show that a mean-variance model overfits the data in cases where a mean-only adjustment is needed, and that the mean-only model is not always sufficient. </plain></SENT>
<SENT sid="239" pm="."><plain>Therefore, it is necessary to evaluate the degree of batch effect, and select the appropriate ComBat version for batch correction. </plain></SENT>
<SENT sid="240" pm="."><plain>More details of this analysis are available in Additional file 1. </plain></SENT>
</text></p><p><text><SENT sid="241" pm="."><plain>We also note that the nitric oxide dataset gives conflicting results for the sample-wise and gene-wise variance tests. </plain></SENT>
<SENT sid="242" pm="."><plain>We emphasize that, though both the sample- and gene-wise tests intend to detect differences in the hyper-moments across batches, they interrogate different aspects of the batch effect: sample-wise P-values reflect the difference in moments between batches by summarizing information over genes; while gene-wise P-values neglect differences between samples by summarizing across samples to estimate the gene-wise moments. </plain></SENT>
<SENT sid="243" pm="."><plain>We have shown in our previous work that multiple diagnostics are often needed to fully diagnose batch effects, as batch effects can be present in many different ways [20]. </plain></SENT>
<SENT sid="244" pm="."><plain>Thus we recommend using mean/variance ComBat if either of the gene-wise or sample-wise tests show a significant batch effect. </plain></SENT>
</text></p></sec></sec><sec id="Sec21"><title><text><SENT sid="245" pm="."><plain>Higher order moment-based batch adjustment </plain></SENT>
</text></title><p><text><SENT sid="246" pm="."><plain>We observed evidence in all four datasets that the current ComBat mean/variance model does not completely remove all batch effects (Fig. 3). </plain></SENT>
<SENT sid="247" pm="."><plain>The bladder cancer has significant differences in gene-wise kurtosis even after mean/variance adjustment. </plain></SENT>
<SENT sid="248" pm="."><plain>The lung cancer data has remaining batch effect in sample-wise skewness. </plain></SENT>
<SENT sid="249" pm="."><plain>Also, the gene-wise test on skewness remains significant in all datasets (Table 1). </plain></SENT>
<SENT sid="250" pm="."><plain>These results suggest that a more severe batch correction targeting the higher order moments may be necessary, indicating the need to develop additional methods and tools for these cases. Fig. 3Distributions of higher order moments in the bladder cancer dataset after the mean/variance adjustment. </plain></SENT>
<SENT sid="251" pm="."><plain>The current mean/variance ComBat does not adjust higher order moments, thus distributions of these moment estimates remain significantly different (a sample-wise kurtosis: P=3.025e−05 using non-robust test; b gene-wise skewness: P=0; c gene-wise kurtosis: P=0.0012 using robust test) across batches even after batch adjustment. </plain></SENT>
<SENT sid="252" pm="."><plain>These may cause problems in downstream analysis such as prediction tasks, and call for batch correction methods that adjust the higher order moments </plain></SENT>
</text></p></sec><sec id="Sec22"><title><text><SENT sid="253" pm="."><plain>Batch adjustment based on a reference batch </plain></SENT>
</text></title><p><text><SENT sid="254" pm="."><plain>We used pathway signature projection examples to establish the benefits of reference-batch ComBat. </plain></SENT>
<SENT sid="255" pm="."><plain>First, we use a simulated pathway dataset to compare the benefits of the original and new reference-batch versions of ComBat. </plain></SENT>
<SENT sid="256" pm="."><plain>The goal of this simulation is to justify the necessity of reference-batch ComBat in scenarios when one batch is of superior quality than the other batches, or when biomarkers need to be generated in one dataset, fixed, and then applied to another dataset. </plain></SENT>
<SENT sid="257" pm="."><plain>We further illustrate that reference-batch ComBat yields better prediction results than the original ComBat in a real data signature profiling example for predicting drug efficacy. </plain></SENT>
</text></p><sec id="Sec23"><title><text><SENT sid="258" pm="."><plain>Simulation study </plain></SENT>
</text></title><p><text><SENT sid="259" pm="."><plain>We used simulated data to represent a gene expression signature study for an activated (or knocked down) biological pathway or drug perturbation that is profiled into another batch of data to predict pathway activity (or drug efficacy). </plain></SENT>
<SENT sid="260" pm="."><plain>Descriptions of these simulated datasets are detailed in the Dataset descriptions - Pathway simulation section. </plain></SENT>
<SENT sid="261" pm="."><plain>We used the two versions of ComBat (original and reference) to combine the two batches and to enable the prediction of the activity strength of the pathway from batch 1 into the batch 2 samples. </plain></SENT>
<SENT sid="262" pm="."><plain>Batch 1 was selected as reference for the reference-batch ComBat. </plain></SENT>
<SENT sid="263" pm="."><plain>Pathway activation levels are added in both versions ComBat as covariates. </plain></SENT>
<SENT sid="264" pm="."><plain>Results of not using activation levels as covariates is shown in Additional file 1: Figure S5. </plain></SENT>
</text></p><p><text><SENT sid="265" pm="."><plain>The original and reference-batch ComBat yield very different results in the two batches (Fig. 4). </plain></SENT>
<SENT sid="266" pm="."><plain>The original ComBat uses the overall mean and variance of each gene across all batches as a background profile. </plain></SENT>
<SENT sid="267" pm="."><plain>Due to the large sample size and variances of the second batch, the estimated background profiles resemble batch 2 in variance. </plain></SENT>
<SENT sid="268" pm="."><plain>As a result, ComBat significantly increased the variance of batch 1 to match the variance of batch 2. </plain></SENT>
<SENT sid="269" pm="."><plain>As illustrated in Fig 4, the original ComBat results in a near complete loss of signal in batch 1. </plain></SENT>
<SENT sid="270" pm="."><plain>In comparison, reference-batch ComBat does not change the chosen reference (batch 1). </plain></SENT>
<SENT sid="271" pm="."><plain>It estimates the background means and variances based on batch 1, and adjusts batch 2 accordingly. </plain></SENT>
<SENT sid="272" pm="."><plain>After adjustment, the true signals of the pathway are recovered in the second batch. </plain></SENT>
<SENT sid="273" pm="."><plain>In this setting where batch 1 is of better quality, but batch 2 is more variable and larger in size, reference-batch ComBat retrieves biological signals of interest more successfully than the original version. </plain></SENT>
<SENT sid="274" pm="."><plain>This is further demonstrated quantitatively by the k-means clustering shown in Fig. 5. </plain></SENT>
<SENT sid="275" pm="."><plain>However, we note that the true activation level of signature genes are included as covariates in ComBat in this example. </plain></SENT>
<SENT sid="276" pm="."><plain>In a more realistic setting, the activation levels are unknown and cannot be included as covariates in the ComBat adjustment. </plain></SENT>
<SENT sid="277" pm="."><plain>When we applied ComBat without covariates (Additional file 1: Figure S5), the pathway activation signals are less clear in both batches. </plain></SENT>
<SENT sid="278" pm="."><plain>However, the original version of ComBat still increases the variance in batch 1, making the data less ideal for signature development than those from the reference version. Fig. 4Simulated pathway datasets before and after batch correction using original and reference-batch ComBat. </plain></SENT>
<SENT sid="279" pm="."><plain>The figure shows the heatmaps of the gene-by-sample expression matrices for the two simulated batches. </plain></SENT>
<SENT sid="280" pm="."><plain>Pathway activation levels are included as covariates in the two versions of ComBat. </plain></SENT>
<SENT sid="281" pm="."><plain>Batch 1 is less variable than batch 2, and is better in quality for identifying signatures for the pathway. </plain></SENT>
<SENT sid="282" pm="."><plain>Using the original ComBat does not remove the variance in batch 2. </plain></SENT>
<SENT sid="283" pm="."><plain>Instead, it causes a severe loss of signal in batch 1 by inflating the variance. </plain></SENT>
<SENT sid="284" pm="."><plain>Reference-batch ComBat does not change the chosen reference (batch 1) and leads to clearer signal detection in batch 2Fig. 5Cluster assignment of the 200 genes using k-means algorithm, where k=2. </plain></SENT>
<SENT sid="285" pm="."><plain>Color bars show the 200 genes from top to bottom, which corresponds to the gene labels in Fig. 4. </plain></SENT>
<SENT sid="286" pm="."><plain>The red and blue bars represent signature and control genes, respectively. </plain></SENT>
<SENT sid="287" pm="."><plain>During batch adjustment, true activation levels are included as covariates, as opposed to using no covariates in both versions of ComBat (Additional file 1: Figure S6). </plain></SENT>
<SENT sid="288" pm="."><plain>In the batch adjusted data, we first clustered genes into 2 groups without specifying the group sizes or labels. </plain></SENT>
<SENT sid="289" pm="."><plain>Then, clusters are assigned as signature and control by how it best accords with the original separation. a In batch 1, genes are correctly separated. </plain></SENT>
<SENT sid="290" pm="."><plain>But combining batch 2 with batch 1 without ComBat adjustment changes the signature / non-signature separation. </plain></SENT>
<SENT sid="291" pm="."><plain>Only 58.5% genes remain the same in the combined dataset. b Reference-batch ComBat gives cluster assignment that is more consistent with the true separation than original ComBat, in batch 1 only, batch 2 only, and the combined dataset of batch 1 and 2. </plain></SENT>
<SENT sid="292" pm="."><plain>These results suggest that the original ComBat breaks the similarity between genes in the same group (signature or control), where similarity is measured by the Euclidean distance. </plain></SENT>
<SENT sid="293" pm="."><plain>Only reference-batch ComBat is able to preserve this similarity </plain></SENT>
</text></p><p><text><SENT sid="294" pm="."><plain>To quantify the impact of batch correction on batch 1, we use a k-means clustering approach to attempt to identify the biomarker gene set (the first 100 genes are the signature genes and the subsequent 100 genes are unaffected by the perturbation). </plain></SENT>
<SENT sid="295" pm="."><plain>We treat the gene expression of each sample as high-dimensional vectors (batch 1: 6 samples ; batch 2: 600 samples). </plain></SENT>
<SENT sid="296" pm="."><plain>We used k-means clustering to divide these vectors into two groups for batch 1 alone, batch 2 alone, and batches 1 and 2 combined, with both ComBat adjustments (original and reference). </plain></SENT>
<SENT sid="297" pm="."><plain>We compared the clustering assignment of genes with the signature/non-signature separation, and calculated the accuracy as the maximum percentage of correctly classified genes in either way of labeling the two clusters as signatures and non-signatures. </plain></SENT>
<SENT sid="298" pm="."><plain>We evaluated how using original and reference-batch ComBat affects this accuracy. </plain></SENT>
</text></p><p><text><SENT sid="299" pm="."><plain>In batch 1 without adjustment, all genes are correctly separated into signature and non-signature. </plain></SENT>
<SENT sid="300" pm="."><plain>However, this separation is confounded when batch 2 is combined with batch 1, as only 58.5% of the genes are correctly separated in the combined dataset. </plain></SENT>
<SENT sid="301" pm="."><plain>When using original ComBat, because the variance of batch 1 is artificially increased, the accuracy in batch 1 alone drops from 100 to 54.5%, and only 64.5% of the genes maintain their correct signature/non-signature labels after combining batch 2 with batch 1. </plain></SENT>
<SENT sid="302" pm="."><plain>In contrast, reference-batch ComBat keeps the cluster assignment in the adjusted batch 1 100% correct, because batch 1 stays intact as the reference, and 91% of the genes retain their correct labels in the combined dataset after adjustment. </plain></SENT>
<SENT sid="303" pm="."><plain>Thus reference ComBat improves the ability to identify biomarker genes across multiple studies compared to no adjustment and standard ComBat. </plain></SENT>
</text></p></sec><sec id="Sec24"><title><text><SENT sid="304" pm="."><plain>EGFR signature and drug prediction </plain></SENT>
</text></title><p><text><SENT sid="305" pm="."><plain>We also considered a real signature study using ASSIGN [23], a pathway profiling toolkit based on a Bayesian factor analysis approach, to develop an EGFR pathway signature from the oncogenic signature dataset. </plain></SENT>
<SENT sid="306" pm="."><plain>ASSIGN allows for derivation of signatures from a pathway perturbation experiment, and adapts signatures from experimental datasets to disease. </plain></SENT>
<SENT sid="307" pm="."><plain>Our goal was to predict EGFR pathway activity in two RNA-Seq datasets: a breast cancer cell line panel [30] and from breast carcinoma patients in TCGA [31]. </plain></SENT>
<SENT sid="308" pm="."><plain>As in the simulation study, the two RNA-Seq test sets were first combined with the EGFR training set separately, to adjust for the batch effect between the training and the test set. </plain></SENT>
<SENT sid="309" pm="."><plain>ASSIGN then trains biomarkers from the adjusted EGFR training set, and makes predictions of pathway activity in both of the adjusted test sets. </plain></SENT>
<SENT sid="310" pm="."><plain>We compared the impact of using three versions of ComBat (original, mean-only and reference-batch), as well as frozen SVA and RUV on these predictions (Table 2). Table 2Comparison between five batch correction methods in predicting pathway activity and drug efficacyCorrelation: EGFR protein expressionDrug response in cell linesComBat versionCommon genes (cell line vs. TCGA)Cell lineTCGAErlotinibGSK1120212Original ComBat20 (40%)0.3160.1320.3600.401Mean-only ComBat44 (88%)0.331-0.0420.2940.407Reference-batch ComBat50 (100%)0.4420.2990.4150.520Frozen SVA50 (100%)0.1150.092-0.09-0.131RUV40 (80%)0.2870.1820.3320.145We combined the oncogenic signature dataset with the cell line and TCGA patient data separately to adjust for batch effect and enable the profiling of EGFR signatures from the oncogenic data to the test sets. </plain></SENT>
<SENT sid="311" pm="."><plain>We observed the set bias using original ComBat (40% same signature genes), mean-only ComBat (88% same genes), and RUV (80% same genes) to combine the datasets. </plain></SENT>
<SENT sid="312" pm="."><plain>Reference-batch ComBat and frozen SVA kept the same signature genes. </plain></SENT>
<SENT sid="313" pm="."><plain>Also, using reference-batch ComBat gave the highest correlations of prediction scores with both protein expression and drug response, among all five batch correction methods. </plain></SENT>
<SENT sid="314" pm="."><plain>These results support the benefit of using reference-batch ComBat in this context </plain></SENT>
</text></p><p><text><SENT sid="315" pm="."><plain>We used ASSIGN to develop a 50-gene signature from the EGFR samples in the training set [21]. </plain></SENT>
<SENT sid="316" pm="."><plain>We first focus on the three versions of ComBat in the ability to generate replicable signatures. </plain></SENT>
<SENT sid="317" pm="."><plain>Because of the ’set bias’ caused by using original ComBat, only 20 (40%) of the signature genes are the same between the signatures developed in the training set adjusted against the cell line test set compared to the training set adjusted against the patient data. </plain></SENT>
<SENT sid="318" pm="."><plain>The same analysis performed with mean-only ComBat produced gene signatures with 44 (88%) of the genes shared between the two datasets. </plain></SENT>
<SENT sid="319" pm="."><plain>Because reference-batch ComBat does not change the EGFR dataset, the signatures are identical after (separate) adjustment with the two test sets. </plain></SENT>
<SENT sid="320" pm="."><plain>This points to the value of using reference ComBat to develop fixed genomic biomarkers that can be projected into multiple datasets, even at different times and without the need to combine all the data together. </plain></SENT>
</text></p><p><text><SENT sid="321" pm="."><plain>We further compared the correlations of pathway predictions with the following validation datasets: (1) EGFR protein expression data (cell line and TCGA), and (2) EGFR inhibitor drug response (cell lines). </plain></SENT>
<SENT sid="322" pm="."><plain>As shown in Table 2, the correlations with protein expression for the reference-batch ComBat adjusted data (Cell Line: 0.442, TCGA: 0.299) are the highest in both test sets among all five methods. </plain></SENT>
<SENT sid="323" pm="."><plain>The correlations with drug response are also the highest when adjusting the data with reference-batch ComBat. </plain></SENT>
<SENT sid="324" pm="."><plain>For example, reference adjusted data yield a correlation of 0.415 with Erlotinib response and 0.520 with GSK1120212 response, compared to using the original (Erlotinib: 0.360, GSK: 0.401) and mean-only (Erlotinib: 0.294, GSK: 0.407) ComBat, frozen SVA (Erlotinib: -0.09, GSK: -0.131), and RUV (Erlotinib: 0.332, GSK: 0.145). </plain></SENT>
<SENT sid="325" pm="."><plain>These results strongly justify the benefits of the reference version of ComBat in pathway profiling and predicting drug efficacy. </plain></SENT>
</text></p></sec></sec></sec></SecTag><SecTag type="DISCUSS"><sec id="Sec25" sec-type="discussion"><title><text><SENT sid="326" pm="."><plain>Discussion </plain></SENT>
</text></title><p><text><SENT sid="327" pm="."><plain>Combining multiple genomic datasets is beneficial for boosting statistical power of studies, especially in cases where data are generated in small batches necessitated by high experimental cost or difficulties in collecting samples. </plain></SENT>
<SENT sid="328" pm="."><plain>In addition, combining batches of data from similar experiments from different labs also provides opportunities for increased power for the detection of biological differences, as well as providing ways for testing/validating biomarkers generated in one batch of data. </plain></SENT>
<SENT sid="329" pm="."><plain>The presence of batch effects due to technical heterogeneity and batch effects due to different profiling platforms, protocols, or other factors can often confound the biological signals in data, which reduces the benefit of combining datasets. </plain></SENT>
<SENT sid="330" pm="."><plain>Despite the many previously developed techniques for batch adjustment, there are still situations where new methods need to be developed to appropriately or more effectively remove batch effects. </plain></SENT>
</text></p><p><text><SENT sid="331" pm="."><plain>We introduced new models and tools for addressing batch correction in several scenarios based on the ComBat model. </plain></SENT>
<SENT sid="332" pm="."><plain>For example, many methods focus on adjusting the means and variances of batches, but some datasets require less (or more) stringent adjustments. </plain></SENT>
<SENT sid="333" pm="."><plain>We proposed two significance testing approaches, based on the batch effect moment distributions, to diagnose the degree of adjustment required. </plain></SENT>
<SENT sid="334" pm="."><plain>We visualized different degrees of batch effect detected by these tests in four experimental datasets. </plain></SENT>
<SENT sid="335" pm="."><plain>In the bladder cancer data where mean is significantly different across batches but not the variance, our proposed mean-only ComBat successfully removes the batch differences. </plain></SENT>
<SENT sid="336" pm="."><plain>In all four datasets, we presented evidence that adjusting both mean and variance is not sufficient to remove all batch effect, which calls for a method that performs a more severe batch adjustment. </plain></SENT>
</text></p><p><text><SENT sid="337" pm="."><plain>For datasets where a less severe adjustment targeting the mean is sufficient, adjusting the variance may lead to unnecessary costs in downstream analysis. </plain></SENT>
<SENT sid="338" pm="."><plain>The original ComBat model pools all samples to estimate both the mean and the variance batch effects, which introduces a correlation structure between the samples. </plain></SENT>
<SENT sid="339" pm="."><plain>Such correlations may cause issues in further analysis, such as inflating type I error rate in differential expression detection, if we do not account for them properly. </plain></SENT>
<SENT sid="340" pm="."><plain>Therefore, for the datasets with only mean batch effect, our proposed mean-only ComBat is able to avoid the cost of estimating the variances, and is more beneficial than the mean-variance version. </plain></SENT>
</text></p><p><text><SENT sid="341" pm="."><plain>It is important to highlight that a thorough evaluation of the degree of batch effect is necessary before applying any version of ComBat. </plain></SENT>
<SENT sid="342" pm="."><plain>We presented simulation results to demonstrate that using the ComBat model corresponding to the type of batch effect in the data is able to achieve more statistical power at the same cost of type I error rate in differential expression analysis. </plain></SENT>
<SENT sid="343" pm="."><plain>Therefore, we strongly suggest evaluating whether there is differences in mean and variances between batches with the moment-based significance tests, and selecting the appropriate version of ComBat based on the type of batch effect in the data. </plain></SENT>
</text></p><p><text><SENT sid="344" pm="."><plain>Also, we noticed that the gene-wise and sample-wise tests yielded different results in a few of our datasets. </plain></SENT>
<SENT sid="345" pm="."><plain>To resolve a conflicting result from the two tests, we recommend visualizing the batch distributions as we did in this study, and decide the level of adjustment required based on all available information. </plain></SENT>
<SENT sid="346" pm="."><plain>BatchQC offers visualizations from various aspects including boxplot of gene expressions, dendrogram of clustering, and scatter plot of principal components, which can all assist in diagnosing the degree of batch effect. </plain></SENT>
</text></p><p><text><SENT sid="347" pm="."><plain>In addition, we illustrated the benefits of selecting a reference batch in batch correction, in situations when one batch is high quality and less variable, and when biomarkers need to be developed from one study, fixed and validated on another study. </plain></SENT>
<SENT sid="348" pm="."><plain>Particularly in the situation where the goal is to generate fixed biomarkers, including an extra batch of data to those in hand can strongly affect the results, an issue described as ‘set bias’. </plain></SENT>
<SENT sid="349" pm="."><plain>In these situations, analysis need to be re-run in order to process the new batch of data, which can cause the biomarker genes to be largely different. </plain></SENT>
</text></p><p><text><SENT sid="350" pm="."><plain>Our reference-batch ComBat is proven more successful in retrieving biological signals in signature profiling examples, where one batch shows a clear signal of biological conditions. </plain></SENT>
<SENT sid="351" pm="."><plain>We demonstrated that reference-batch ComBat resolves the ‘set bias’ caused by the original version of ComBat in adding data sequentially, and yields better prediction of pathway activities and drug effects. </plain></SENT>
<SENT sid="352" pm="."><plain>Although these approaches are only alternative expressions of the ComBat model, their implementation has critical impact in real batch correction scenarios. </plain></SENT>
</text></p></sec></SecTag><SecTag type="CONCL"><sec id="Sec26" sec-type="conclusion"><title><text><SENT sid="353" pm="."><plain>Conclusions </plain></SENT>
</text></title><p><text><SENT sid="354" pm="."><plain>We proposed diagnostic tools and improved models based on ComBat to evaluate and address batch effects in certain batch adjustment situations. </plain></SENT>
<SENT sid="355" pm="."><plain>The significance tests for batch differences can be used to determine the degree of batch effects to be adjusted. </plain></SENT>
<SENT sid="356" pm="."><plain>We purposed mean-only ComBat for the situation where a less severe adjustment is preferred. </plain></SENT>
<SENT sid="357" pm="."><plain>The reference-batch ComBat is able to leave one batch unchanged, which is especially useful for generating a fixed biomarker for further clinical use. </plain></SENT>
<SENT sid="358" pm="."><plain>We have shown in both simulations and real data that these proposed methods provide better solutions to batch effects than the existing ComBat model in their corresponding batch correction scenarios. </plain></SENT>
</text></p></sec></SecTag><sec sec-type="supplementary-material"><title><text><SENT sid="359" pm="."><plain>Additional files </plain></SENT>
</text></title><sec id="Sec27"><p><text><SENT sid="360" pm="."><plain>Additional file 1Supplementary materials (PDF 1612 kb) </plain></SENT>
</text></p><p><text><SENT sid="361" pm="."><plain>Additional file 2Mean and variance of gene expression distributions estimated from the EGFR signature and the TCGA breast cancer patient datasets. </plain></SENT>
<SENT sid="362" pm="."><plain>In TCGA, we used proteomics data of the patients, and binned the EGFR protein expression into 6 gradually increasing levels, partitioning all patients into 6 equal-sized groups. </plain></SENT>
<SENT sid="363" pm="."><plain>Mean and variances are estimated within each group. </plain></SENT>
<SENT sid="364" pm="."><plain>Up- and down-regulated genes are both EGFR signature genes derived by ASSIGN. </plain></SENT>
<SENT sid="365" pm="."><plain>The design and parameters for our simulation studies resemble the real estimates in these tables. </plain></SENT>
<SENT sid="366" pm="."><plain>Batch 1 represents the EGFR signature dataset with small gene variances, and a clear separation between the two condition groups in the expression of up-regulated genes. </plain></SENT>
<SENT sid="367" pm="."><plain>Batch 2 resembles the TCGA patient data with much larger variances than Batch 1. </plain></SENT>
<SENT sid="368" pm="."><plain>(XLSX 10 kb) </plain></SENT>
</text></p><p><text><SENT sid="369" pm="."><plain>Additional file 3Comparison of P-values for applying robust and non-robust F tests on the four experimental datasets. </plain></SENT>
<SENT sid="370" pm="."><plain>(XLSX 12 kb) </plain></SENT>
</text></p></sec></sec></body><back><SecTag type="ABBR"><glossary><title>Abbreviations</title><def-list><def-item><term>CIS</term><def><p>carcinoma in situ</p></def></def-item><def-item><term>DWD</term><def><p>distance weighted discrimination</p></def></def-item><def-item><term>GEO</term><def><p>the Gene Expression Omnibus database</p></def></def-item><def-item><term>GFP</term><def><p>green fluorescent protein</p></def></def-item><def-item><term>GFRN</term><def><p>growth factor receptor network</p></def></def-item><def-item><term>HMEC</term><def><p>human mammary epithelial cell</p></def></def-item><def-item><term>NO</term><def><p>nitric oxide</p></def></def-item><def-item><term>RUV</term><def><p>remove unwanted variation</p></def></def-item><def-item><term>sTCC</term><def><p>superficial transitional cell carcinoma</p></def></def-item><def-item><term>SVA</term><def><p>surrogate variable analysis</p></def></def-item><def-item><term>SVD</term><def><p>singular value decomposition</p></def></def-item><def-item><term>TCGA</term><def><p>The Cancer Genome Atlas</p></def></def-item><def-item><term>XPN</term><def><p>cross-platform normalization</p></def></def-item></def-list></glossary></SecTag><fn-group><fn><p><text><SENT sid="371" pm="."><plain>Electronic supplementary material </plain></SENT>
</text></p><p><text><SENT sid="372" pm="."><plain>The online version of this article (10.1186/s12859-018-2263-6) contains supplementary material, which is available to authorized users. </plain></SENT>
</text></p></fn><fn><p><text><SENT sid="373" pm="."><plain>David F. </plain></SENT>
<SENT sid="374" pm="."><plain>Jenkins and Solaiappan Manimaran contributed equally to this work. </plain></SENT>
</text></p></fn></fn-group><SecTag type="ACK_FUND"><ack><title>Acknowledgements</title><p><text4fund><text><SENT sid="375" pm="."><plain>We would like to thank our collaborators in the Spira-Lenburg lab in Division of Computational Biomedicine, Boston University for providing the lung cancer data. </plain></SENT>
</text></text4fund></p><sec id="d29e2188"><title>Funding</title><p><text4fund><text><SENT sid="376" pm="."><plain>This work was supported by grants from the NIH R01ES025002 and U01CA164720. </plain></SENT>
<SENT sid="377" pm="."><plain>The funding body, NIH, did not play any roles in the design of the study, the collection, analysis, and interpretation of data, or in writing the manuscript. </plain></SENT>
</text></text4fund></p></sec><sec id="d29e2193"><title>Availability of data and materials</title><p><text4fund><text><SENT sid="378" pm="."><plain>The code to recreate the simulated datasets, and to reproduce the results of this study, are available at the author’s Github repository, <ext-link ext-link-type="uri" xlink:href="https://github.com/zhangyuqing/meanonly_reference_combat">https://github.com/zhangyuqing/meanonly_reference_combat</ext-link>. </plain></SENT>
<SENT sid="379" pm="."><plain>The bladder cancer dataset is available in the “bladderbatch” Bioconductor package [22]. </plain></SENT>
<SENT sid="380" pm="."><plain>The nitric oxide dataset is available from the corresponding author on reasonable request. </plain></SENT>
<SENT sid="381" pm="."><plain>Both the oncogenic signature and the lung cancer datasets are publicly available in the Gene Expression Omnibus database [32], with accession numbers (oncogenic signature: GSE83083, GSE59765; lung cancer: GSE994, GSE4115, GSE7895, GSE66499, and GSE37147). </plain></SENT>
<SENT sid="382" pm="."><plain>See the “Dataset descriptions” section for further details. </plain></SENT>
</text></text4fund></p></sec></ack></SecTag><SecTag type="SUPPL"><notes notes-type="author-contribution"><title>Authors’ contributions</title><p>YZ performed the data analysis, implemented the reference-batch ComBat software, visualized the results, and wrote and revised the manuscript. DFJ performed the pathway profiling analysis using EGFR signature data, and summarized the results. SM designed and implemented the tests for batch moment distributions, which are distributed through the BatchQC package. WEJ conceived and supervised the project, and wrote the first draft of the manuscript. All authors read and approved the final manuscript.</p></notes></SecTag><notes notes-type="COI-statement"><sec id="d29e2218"><title>Ethics approval and consent to participate</title><p>Not applicable.</p></sec><sec id="d29e2223"><title>Consent for publication</title><p>Not applicable.</p></sec><sec id="d29e2228"><title>Competing interests</title><p>The authors declare that they have no competing interests.</p></sec><sec id="d29e2233"><title>Publisher’s Note</title><p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p></sec></notes><SecTag type="REF"><ref-list id="Bib1"><title>References</title><ref id="CR1"><text><SENT sid="383" pm="."><plain>1SoonWWHariharanMSnyderMPHigh-throughput sequencing for biology and medicineMol Syst Biol20139164010.1038/msb.2012.61<?supplied-pmid 23340846?>23340846 </plain></SENT>
</text></ref><ref id="CR2"><text><SENT sid="384" pm="."><plain>2ReuterJASpacekDVSnyderMPHigh-throughput sequencing technologiesMol Cell20155845869710.1016/j.molcel.2015.05.004<?supplied-pmid 26000844?>26000844 </plain></SENT>
</text></ref><ref id="CR3"><text><SENT sid="385" pm="."><plain>3Van DijkELAugerHJaszczyszynYThermesCTen years of next-generation sequencing technologyTrends Genet20143094182610.1016/j.tig.2014.07.001<?supplied-pmid 25108476?>25108476 </plain></SENT>
</text></ref><ref id="CR4"><text><SENT sid="386" pm="."><plain>4TomczakKCzerwińskaPWiznerowiczMThe cancer genome atlas (tcga): an immeasurable source of knowledgeContemp Oncol2015191A68 </plain></SENT>
</text></ref><ref id="CR5"><text><SENT sid="387" pm="."><plain>5KupferPGuthkeRPohlersDHuberRKoczanDKinneRWBatch correction of microarray data substantially improves the identification of genes differentially expressed in rheumatoid arthritis and osteoarthritisBMC Med Genom2012512310.1186/1755-8794-5-23 </plain></SENT>
</text></ref><ref id="CR6"><text><SENT sid="388" pm="."><plain>6LuoJSchumacherMSchererASanoudouDMegherbiDDavisonTShiTTongWShiLHongHA comparison of batch effect removal methods for enhancement of prediction performance using maqc-ii microarray gene expression dataPharmacogenomics J20101042789110.1038/tpj.2010.57<?supplied-pmid 20676067?>20676067 </plain></SENT>
</text></ref><ref id="CR7"><text><SENT sid="389" pm="."><plain>7AlterOBrownPOBotsteinDSingular value decomposition for genome-wide expression data processing and modelingProc Natl Acad Sci2000971810101610.1073/pnas.97.18.10101<?supplied-pmid 10963673?>10963673 </plain></SENT>
</text></ref><ref id="CR8"><text><SENT sid="390" pm="."><plain>8BenitoMParkerJDuQWuJXiangDPerouCMMarronJSAdjustment of systematic microarray data biasesBioinformatics20042011051410.1093/bioinformatics/btg385<?supplied-pmid 14693816?>14693816 </plain></SENT>
</text></ref><ref id="CR9"><text><SENT sid="391" pm="."><plain>9ShabalinAATjelmelandHFanCPerouCMNobelABMerging two gene-expression studies via cross-platform normalizationBioinformatics200824911546010.1093/bioinformatics/btn083<?supplied-pmid 18325927?>18325927 </plain></SENT>
</text></ref><ref id="CR10"><text><SENT sid="392" pm="."><plain>10JohnsonWELiCRabinovicAAdjusting batch effects in microarray expression data using empirical bayes methodsBiostatistics2007811182710.1093/biostatistics/kxj037<?supplied-pmid 16632515?>16632515 </plain></SENT>
</text></ref><ref id="CR11"><text><SENT sid="393" pm="."><plain>11Gagnon-BartschJASpeedTPUsing control genes to correct for unwanted variation in microarray dataBiostatistics20121335395210.1093/biostatistics/kxr034<?supplied-pmid 22101192?>22101192 </plain></SENT>
</text></ref><ref id="CR12"><text><SENT sid="394" pm="."><plain>12LeekJTJohnsonWEParkerHSJaffeAEStoreyJDThe sva package for removing batch effects and other unwanted variation in high-throughput experimentsBioinformatics2012286882310.1093/bioinformatics/bts034<?supplied-pmid 22257669?>22257669 </plain></SENT>
</text></ref><ref id="CR13"><text><SENT sid="395" pm="."><plain>13PatilPBachant-WinnerP-OHaibe-KainsBLeekJTTest set bias affects reproducibility of gene signaturesBioinformatics2015311423182310.1093/bioinformatics/btv157<?supplied-pmid 25788628?>25788628 </plain></SENT>
</text></ref><ref id="CR14"><text><SENT sid="396" pm="."><plain>14LazarCMeganckSTaminauJSteenhoffDColettaAMolterCWeiss-SolísDYDuqueRBersiniHNowéABatch effect removal methods for microarray gene expression data integration: a surveyBrief Bioinform20121444699010.1093/bib/bbs037<?supplied-pmid 22851511?>22851511 </plain></SENT>
</text></ref><ref id="CR15"><text><SENT sid="397" pm="."><plain>15KitchenRRSabineVSSimsAHMacaskillEJRenshawLThomasJSvan HemertJIDixonJMBartlettJMCorrecting for intra-experiment variation in illumina beadchip data is necessary to generate robust gene-expression profilesBMC Genom201011113410.1186/1471-2164-11-134 </plain></SENT>
</text></ref><ref id="CR16"><text><SENT sid="398" pm="."><plain>16SîrbuARuskinHJCraneMCross-platform microarray data normalisation for regulatory network inferencePLoS ONE20105111382210.1371/journal.pone.0013822 </plain></SENT>
</text></ref><ref id="CR17"><text><SENT sid="399" pm="."><plain>17Bolstad BM, Irizarry RA, Åstrand M, Speed TP. </plain></SENT>
<SENT sid="400" pm="."><plain>A comparison of normalization methods for high density oligonucleotide array data based on variance and bias. </plain></SENT>
<SENT sid="401" pm="."><plain>Bioinformatics. </plain></SENT>
<SENT sid="402" pm="."><plain>2003;19(2):185–93. </plain></SENT>
</text></ref><ref id="CR18"><text><SENT sid="403" pm="."><plain>18LinMLucas JrHCShmueliGResearch commentary—too big to fail: large samples and the p-value problemInf Syst Res20132449061710.1287/isre.2013.0480 </plain></SENT>
</text></ref><ref id="CR19"><text><SENT sid="404" pm="."><plain>19LeekJTScharpfRBBravoHCSimchaDLangmeadBJohnsonWEGemanDBaggerlyKIrizarryRATackling the widespread and critical impact of batch effects in high-throughput dataNat Rev Genet20101110733910.1038/nrg2825<?supplied-pmid 20838408?>20838408 </plain></SENT>
</text></ref><ref id="CR20"><text><SENT sid="405" pm="."><plain>20ManimaranSSelbyHMOkrahKRubermanCLeekJTQuackenbushJHaibe-KainsBBravoHCJohnsonWEBatchqc: interactive software for evaluating sample and batch effects in genomic dataBioinformatics201632243836810.1093/bioinformatics/btw538<?supplied-pmid 27540268?>27540268 </plain></SENT>
</text></ref><ref id="CR21"><text><SENT sid="406" pm="."><plain>21RahmanMMacNeilSMJenkinsDFShresthaGWyattSRMcQuerryJAPiccoloSRHeiserLMGrayJWJohnsonWEActivity of distinct growth factor receptor network components in breast tumors uncovers two biologically relevant subtypesGenome Med2017914010.1186/s13073-017-0429-x<?supplied-pmid 28446242?>28446242 </plain></SENT>
</text></ref><ref id="CR22"><text><SENT sid="407" pm="."><plain>22Leek JT. bladderbatch: Bladder gene expression data illustrating batch effects. </plain></SENT>
<SENT sid="408" pm="."><plain>R package version 1.18.0. </plain></SENT>
<SENT sid="409" pm="."><plain>2018. </plain></SENT>
<SENT sid="410" pm="."><plain>Available at https://www.bioconductor.org/packages/release/data/experiment/html/bladderbatch.html. </plain></SENT>
<SENT sid="411" pm="."><plain>Accessed 30 June 2018. </plain></SENT>
</text></ref><ref id="CR23"><text><SENT sid="412" pm="."><plain>23ShenYRahmanMPiccoloSRGusenleitnerDEl-ChaarNNChengLMontiSBildAHJohnsonWEAssign: context-specific genomic profiling of multiple heterogeneous biological pathwaysBioinformatics2015311117455310.1093/bioinformatics/btv031<?supplied-pmid 25617415?>25617415 </plain></SENT>
</text></ref><ref id="CR24"><text><SENT sid="413" pm="."><plain>24SpiraABeaneJShahVLiuGSchembriFYangXPalmaJBrodyJSEffects of cigarette smoke on the human airway epithelial cell transcriptomeProc Natl Acad Sci U S A20041012710143810.1073/pnas.0401422101<?supplied-pmid 15210990?>15210990 </plain></SENT>
</text></ref><ref id="CR25"><text><SENT sid="414" pm="."><plain>25SpiraABeaneJEShahVSteilingKLiuGSchembriFGilmanSDumasY-MCalnerPSebastianiPAirway epithelial gene expression in the diagnostic evaluation of smokers with suspect lung cancerNat Med2007133361610.1038/nm1556<?supplied-pmid 17334370?>17334370 </plain></SENT>
</text></ref><ref id="CR26"><text><SENT sid="415" pm="."><plain>26GustafsonAMSoldiRAnderlindCScholandMBQianJZhangXCooperKWalkerDMcWilliamsALiuGAirway pi3k pathway activation is an early and reversible event in lung cancer developmentSci Transl Med20102262625262510.1126/scitranslmed.3000251 </plain></SENT>
</text></ref><ref id="CR27"><text><SENT sid="416" pm="."><plain>27BeaneJSebastianiPLiuGBrodyJSLenburgMESpiraAReversible and permanent effects of tobacco smoke exposure on airway epithelial gene expressionGenome Biol20078920110.1186/gb-2007-8-9-r20117274841 </plain></SENT>
</text></ref><ref id="CR28"><text><SENT sid="417" pm="."><plain>28SilvestriGAVachaniAWhitneyDElashoffMPorta SmithKFergusonJSParsonsEMitraNBrodyJLenburgMEA bronchial genomic classifier for the diagnostic evaluation of lung cancerN Engl J Med201537332435110.1056/NEJMoa1504601<?supplied-pmid 25981554?>25981554 </plain></SENT>
</text></ref><ref id="CR29"><text><SENT sid="418" pm="."><plain>29SteilingKVan Den BergeMHijaziKFloridoRCampbellJLiuGXiaoJZhangXDuclosGDrizikEA dynamic bronchial airway gene expression signature of chronic obstructive pulmonary disease and lung function impairmentAm J Respir Crit Care Med201318799334210.1164/rccm.201208-1449OC<?supplied-pmid 23471465?>23471465 </plain></SENT>
</text></ref><ref id="CR30"><text><SENT sid="419" pm="."><plain>30DaemenAGriffithOLHeiserLMWangNJEnacheOMSanbornZPepinFDurinckSKorkolaJEGriffithMModeling precision treatment of breast cancerGenome Biol2013141011010.1186/gb-2013-14-10-r11023651872 </plain></SENT>
</text></ref><ref id="CR31"><text><SENT sid="420" pm="."><plain>31NetworkCGAComprehensive molecular portraits of human breast tumoursNature20124907418617010.1038/nature1141223000897 </plain></SENT>
</text></ref><ref id="CR32"><text><SENT sid="421" pm="."><plain>32EdgarRDomrachevMLashAEGene expression omnibus: Ncbi gene expression and hybridization array data repositoryNucleic Acids Res20023012071010.1093/nar/30.1.207<?supplied-pmid 11752295?>11752295 </plain></SENT>
</text></ref></ref-list></SecTag></back></article>
